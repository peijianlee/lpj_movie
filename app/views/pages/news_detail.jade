extends ../layout_index

block content
	body.news_index
		.bg_zindex
			.header
				.wrap
					h1 ICOOMTEST
					ul.hmenu
						if newscategories && newscategories.length>0
							each cat in newscategories
								li: a(href="###") #{cat.name}
			.news_list_frame.wrap
				.news_list
					.news_list_info
						span.news_list_tag #{news.newscategoryname}
						| by
						i.icon-user.ml10.mr5
						| #{news.uname} at 
						i.icon-time.ml5.mr5
						span #{moment(news.meta.updateAt).format('YYYY/MM/DD HH:mm:ss')}
					.news_list_info_line
					.news_content
						h2 #{news.title}
						div !{news.content}
			input(type="hidden",value="#{news.id}",name="newsId")
			input(type="hidden",value="#{news.uname}",name="uname")
			input(type="hidden",value="#{totalPage}",name="totalpage")
			input(type="hidden",value="#{totalcomments}",name="totalcomments")


			.comment.wrap
				//- h6 评论区
				ul#comment_list
					each item in comments
						li.c_body
							a.c_avatar.commentBtn(href="#commentsForm", data-cid="#{item._id}", data-tid="#{item.from._id}")
								img(src="http://www.easyicon.net/api/resizeApi.php?id=1132617&size=32")
							div.c_comment
								h5 
									small.fr #{moment(item.meta.createAt).format('YYYY/MM/DD HH:mm:ss')}
									| #{item.from.name}
								p !{item.content}
								if item.reply && item.reply.length > 0
									each reply in item.reply
										.c_body
											a.c_avatar.commentBtn(href="#commentsForm", data-cid="#{item._id}", data-tid="#{reply.from._id}")
												img(src="http://www.easyicon.net/api/resizeApi.php?id=1132617&size=32")
											div.c_comment
												h5 
													small.fr #{moment(reply.date).format('YYYY/MM/DD HH:mm:ss')}
													if reply.from.name !== reply.to.name
														| #{reply.from.name}
														small.text-info.icon-share-alt(style="margin:0 10px",title="回复")
														| #{reply.to.name}
													else
														| #{reply.from.name}
												p !{reply.content}
				.page#page.tc.mt10
				script.
				div#commentsForm
					input(type="hidden", name="comment[news]", value="#{news._id}")
					if user
						input(type="hidden", name="comment[from]", value="#{user._id}")
					.form-grounp
						textarea(name="comment[content]")
					if user
						button.button.button-primary.button-longshadow-right.msgSubmitMsn(type="submit") 提交
						//- a.btn.btn-primary.msgSubmitMsn(href="javascript:void(0)") 提交

					else
						a.navbar-link(href="#", data-toggle="modal", data-target="#signinModal") 登录后评论
		.bg_fixed
	script(src="/js/detail.js")
	script.

		var totalPage = document.getElementsByName("totalpage")[0].value
		var totalcomments = document.getElementsByName("totalcomments")[0].value
		var newsId = document.getElementsByName("newsId")[0].value

		//----------------------- 评论翻页
		$('.page').delegate('a','click',function(){

			var $this = $(this);
			if($this.hasClass('page_stand'))return false;

			var pagenum = parseInt($this.text())-1;
			addCommentHTML(pagenum)
		})
		//- 更新评论列表
		function addCommentHTML(pagenum){
			$.ajax({
				type:'get',
				url:'/news/comment?id='+newsId+'&pagenum='+pagenum
			})
			.done(function(results){
				if(results.success===0){
					artalert('获取数据失败，请重新操作。','error')
				}else{
					//- 判读当前总页和服务器总页是否相同
					console.log(results.totalPage+','+totalPage);
					if(results.totalPage==totalPage){
						$('.page a').removeClass('page_stand').eq(pagenum).addClass('page_stand');
					}else{
						addPageBtn(results.totalPage,pagenum)
						document.getElementsByName("totalpage")[0].value = results.totalPage
						totalPage = results.totalPage
					}

					var commentHTML = ''
					for(i=0; i<results.comments.length; i++){
						//- console.log(results.comments[i])
						//- 格式化时间
						var time = moment(results.comments[i].meta.createAt).format('YYYY-MM-DD HH:mm:ss')
						
						commentHTML += '<li class="c_body">'+
							'<a class="c_avatar commentBtn" data-tid="'+results.comments[i]._id+
							'" data-cid="'+
							'" href="#commentsForm">'+
							'<img src="http://www.easyicon.net/api/resizeApi.php?id=1132617&amp;size=32"></a><div class="c_comment"><h5> '+
							'<small class="fr">'+time+
							'</small>'+results.comments[i].from.name+
							'</h5><p>'+results.comments[i].content+'</p></div></li>'
					}
					$('#comment_list').html('').append(commentHTML);

				}
			})

		}

		//- 添加翻页按键
		function addPageBtn(totalPage,pageNum){
			var page = document.getElementById('page')
			alert(pageNum)
			var btn = ''
			if(totalPage>1){
				for(var i=0;i<totalPage; i++){
					if(i==pageNum){
						btn += '<a class="page_stand" href="javascript:;" >'+(i+1)+'</a>'
					}else{
						btn += '<a href="javascript:;" >'+(i+1)+'</a>'
					}
				}
			}
			document.getElementById('page').innerHTML=btn
		}
		addPageBtn(totalPage,0)

		//--------------------- 留言提交
		$('.msgSubmitMsn').click(function(){
			var news = $('input[name="comment[news]"]').val()
			var from = $('input[name="comment[from]"]').val()
			var uname = $('input[name="uname"]').val()
			var content = $('textarea[name="comment[content]"]').val()
			var tid = $('input[name="comment[tid]"]').val()
			var cid = $('input[name="comment[cid]"]').val()

			if(content==""){
				artalert('评论不能为空！')
				return false;
			}

			if(tid==undefined||tid==""){
				//- 评论
				var data = {"from":from,"news":news,"content":content}
			}else{
				//- 回复
				var data = {"from":from,"news":news,"content":content,"tid":tid,"cid":cid}
			}
			
			//- arttip('<i class="icon-spinner icon-spin"></i>&nbsp;&nbsp;uploading...')

			$.ajax({
				type:"POST",
				url:"/user/comment",
				data:data,
				dataType:"json",
				async:false,
				cache:false,
				success: function(data){
					//- var _data = eval("("+data+")");
					if(data.success.cid==undefined){

						//- console.log(data.success)
						//- var commentHTML ='<li class="c_body">'+
						//- 	'<a class="c_avatar commentBtn" data-tid="'+data.success.from+
						//- 	'" data-cid="589c2aac544d7e14a8cee16d" '+
						//- 	'href="#commentsForm"><img src="http://www.easyicon.net/api/resizeApi.php?id=1132617&amp;size=32"></a>'+
						//- 	'<div class="c_comment"><h5> '+
						//- 	'<small class="fr">'+data.success.meta.createAt+
						//- 	'</small>'+uname+'</small></h5>'+
						//- 	'<p>'+data.success.content+'</p></div></li>'
						//- $('#comment_list').prepend(commentHTML)
						//- arttipclose();

						addCommentHTML(0)
					}
				},
				error: function(json){
					artalert('发送失败，请重新操作。','error')
				}

			})
			return false;
		});